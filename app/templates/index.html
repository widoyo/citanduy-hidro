<!doctype html>
<html lang="id">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="{% block page_description %}Sistem Informasi Hidrologi dan Kualitas air (SIHKA), Balai Besar Wilayah Sungai Citanduy{% endblock %}">
    <meta name="googlebot" content="notranslate">
    {%- if canonical_url %}<link rel="canonical" href="{{ canonical_url }}">{% endif %}
    <title>{% block title %}BBWS Citanduy{% endblock %}</title>
    <link rel="icon" type="image/x-icon" href="/static/img/pupr.ico">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="/static/css/custom.css">
    <script src="//unpkg.com/alpinejs" defer></script>
  </head>
  {% if not config['DEBUG'] %}
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id={{ config.GTAG }}"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', '{{ config.GTAG }}');
  </script>
  {% endif %}
  <body x-data="{ open: false }">
    <div style="background-image: url(/static/img/bluetriangle.jpg); background-size: repeat;">
      {% if current_user.is_authenticated %}
      <div class="dropdown">
        <button 
          class="btn btn-outline-light float-end mt-2 me-2" 
          type="button" 
          data-bs-toggle="dropdown"
        ><i
        class="bi bi-person-fill {% if current_user.is_admin %}text-danger {% endif %}me-1"
      ></i> {{ current_user.username }}</button>
        <ul
        class="dropdown-menu dropdown-menu-end"
        aria-labelledby="dropdownMenuLink"
      >
        {% if current_user.is_admin %}

        <li>
          <a href="/pos/manual" class="dropdown-item navlink"
            ><i class="bi bi-pencil me-2 text-danger"></i> Data Manual</a
          >
          <a href="/rpos" class="dropdown-item navlink"
            ><i class="bi bi-cpu me-2 text-danger"></i> Data Logger</a
          >
          <a href="/pos/ka" class="dropdown-item navlink"
            ><i class="bi bi-card-checklist me-2 text-danger"></i> Data Kualitas Air</a
          >
          <a href="/pub/adm" class="dropdown-item navlink"
            ><i class="bi bi-card-checklist me-2 text-danger"></i> Admin Publikasi</a
          >
          <hr class="dropdown-divider" />
          <a href="/pos/manual/kinerja" class="dropdown-item navlink"
            ><i class="bi bi-clipboard2-pulse me-2 text-danger"></i> Kinerja Data Manual</a
          >
          <a href="/rdaily" class="dropdown-item navlink"
            ><i class="bi bi-graph-up me-2 text-danger"></i> Kinerja Telemetri</a
          >
        </li>
        <li>
          <hr class="dropdown-divider" />
        </li>
        <a href="/download" class="dropdown-item navlink"
        ><i class="bi bi-cloud-download me-2 text-danger"></i> Download</a
      >
      <li>
        <hr class="dropdown-divider" />
      </li>
    <a href="/note" class="dropdown-item navlink"
      ><i class="bi bi-book-half me-2 text-danger"></i> LogBook</a
    >
  <li>
          <hr class="dropdown-divider" />
        </li>
        <li>
          <a href="/user" class="dropdown-item navlink"
            ><i class="bi bi-key me-2 text-danger"></i> User</a
          >
        </li>
        <li>
          <a href="/petugas" class="dropdown-item navlink"
            ><i class="bi bi-person me-2 text-danger"></i> Petugas Pos</a
          >
        </li>
        <li>
          <a href="/pos" class="dropdown-item navlink"
            ><i class="bi bi-geo-alt me-2 text-danger"></i> Pos Hidrologi</a
          >
        </li>
        <li>
          <a href="/pos/da" class="dropdown-item navlink"
            ><i class="bi bi-water me-2"></i> Pos Duga Air</a>
        </li>
        {% else %}
        <li>
          <a href="/me" class="dropdown-item navlink"
            ><i class="bi bi-person me-2 text-danger"></i> Profile</a
          >
        </li>
        {% endif %}
        <li>
          <hr class="dropdown-divider" />
        </li>
        <li>
          <a href="/logout" class="dropdown-item navlink"
            ><i class="bi bi-power text-danger me-2"></i> Logout</a
          >
        </li>
      </ul>
      </div>
      {% else %}
      <a href="/login" title="login" class="btn btn-outline-light float-end mt-2 me-2"><i class="bi bi-key"></i> Login</a>
      {% endif %}
      <div class="px-4 py-5 text-center">
        
        <img class="d-block mx-auto mb-5 img-fluid" src="/static/img/cty-logo.png" width="180" height="129" alt="BBWS Citanduy">
        <div class="container-fluid mt-5">
          <div class="row justify-content-center">
            <div class="col">
              <p class="text-light fw-lighter fs-4">Hari ini, {{ ctx.today.strftime('%d %b %Y') }} &bullet; <span x-text="new Date().getHours()"></span></p>
            </div>
          </div>
          <div class="row justify-content-center mt-5">
            <div class="col-md-3 col-sm-12 mt-3 mt-md-0">
              <div class="card text-bg-light text-start">
                <div class="card-body">
                  <h5>Status Hujan</h5>
                  <table class="table mt-3" id="rain-data">
                  </table>
                </div>
              </div>
            </div>
            <div class="col-md-3 col-sm-12 mt-3 mt-md-0">
              <div class="card text-bg-light text-start">
                <div class="card-body">
                  <h5>Status Muka Air</h5>
                  <table class="table mt-3" id="wlevel-data">
                  </table>
                </div>
              </div>
            </div>
          </div>
        <!--h1 class="display-5 pt-5 pb-3 fw-bold text-white">BBWS Citanduy</h1-->
        <div class="col-lg-6 mx-auto">
          <!--p class="lead mb-5 text-light">Data Curah hujan dan Tinggi Muka Air</p-->
          <!--div class="d-grid gap-2 mb-5 d-sm-flex justify-content-sm-center">
            <a href="/map/hujan" type="button" class="btn btn-warning btn-lg px-4 gap-5 me-4"><i class="bi bi-map me-1"></i> Peta Hujan</a>
            <a href="/map/sungai" type="button" class="btn btn-primary btn-lg px-4"><i class="bi bi-map me-1"></i> Peta Sungai</a>
          </div-->
          <!--p><i class="bi bi-cloud-rain text-light me-2"></i> <a href="/pch" class="link-light me-4">Data Curah Hujan</a>  <i class="bi bi-water text-light me-2"></i>&nbsp;<a href="/pda" class="link-light">Data Muka Air</a></p-->
        </div>
      </div>
    </div>
    <div class="px-4 pt-5 text-center border-bottom min-vh-100" style="background-image: url(/static/img/manganti.webp); background-size: cover; background-repeat: no-repeat">
      <h1 class="display-4 fw-lighter text-grey" style="text-shadow: 0 0 6px #ffffff;"></h1>
      <div class="col-lg-6 mx-auto">
      </div>
      </div>
    </div>    
    <div class="container-fluid">
      <footer class="py-3 my-4">
        <p class="text-center text-body-secondary">Â© 2024 - 2025 BBWS Citanduy</p>
      </footer>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        function updateWLevelData() {
          fetch('/ews?wlevel=1')
            .then(response => response.json())
            .then(data => {
              // Process water level data here
              const wlevelDataList = document.getElementById('wlevel-data');
              wlevelDataList.innerHTML = ''; // Clear existing list
              let i = 0;
              data.forEach(item => {
                const listItem = document.createElement('tr');
                console.log('wlevel item', item);
                if (item.status !== 'normal') {
                  i++;
                  listItem.innerHTML = `<td>${item.pos && item.pos.nama ? item.pos.nama : 'Unknown'}</td><td><span class="text-danger">${item.status}</span></td>`;
                  if (i <= 5) {
                    wlevelDataList.appendChild(listItem);
                  }
                }
              });
              const summaryItem = document.createElement('tr');
              summaryItem.innerHTML = `<td colspan="2"><br><a href="/pda">Lihat semua pos</a></td>`;
              wlevelDataList.appendChild(summaryItem);
            })
            .catch(error => console.error('Error fetching water level data:', error));
        }
        function updateRainData() {
          fetch('/ews?rain=1')
            .then(response => response.json())
            .then(data => {
              const rainDataList = document.getElementById('rain-data');
              rainDataList.innerHTML = ''; // Clear existing list
                // sort by rain descending (largest first)
                data.sort((a, b) => (Number(b.rain) || 0) - (Number(a.rain) || 0));

                let i = 0;
                let sumRain = 0;
                let sampling = null;
                data.forEach(item => {
                  if ((Number(item.rain) || 0) <= 0) return; // Skip zero or negative rain
                  i++;
                  if (Number(item.rain) < 1000) {
                    sumRain += Number(item.rain) || 0;
                  }

                  const rainCategoryColor = item.rain >= 100 ? 'text-danger' : item.rain >= 50 ? 'text-warning' : item.rain >= 20 ? 'text-info' : 'text-success';
                  const rainCategory = item.rain >= 100 ? 'Sangat Lebat' : item.rain >= 50 ? 'Lebat' : item.rain >= 20 ? 'Sedang' : 'Ringan';
                  const listItem = document.createElement('tr');
                  listItem.innerHTML = `<td>${item.pos && item.pos.nama ? item.pos.nama : 'Unknown'}</td><td><span class="${rainCategoryColor}">${rainCategory}</span></td>`;
                  if (i <= 5) {
                    rainDataList.appendChild(listItem);
                  }
                  sampling = item.sampling;
                });
                const summaryItem = document.createElement('tr');
                summaryItem.innerHTML = `<td colspan="2"><br><a href="/pch?s=${sampling.split('T')[0]}">${i - 5} pos lain</a>, Rata-rata <b>${(sumRain / i).toFixed(1)}</b>mm</td>`
                rainDataList.appendChild(summaryItem);
            })
            .catch(error => console.error('Error fetching rain data:', error));
        }


        function yourFunction() {
          const now = new Date();
          updateRainData();
          console.log(`Function executed at: ${now.toLocaleTimeString()}`);
          // Place the code you want to run every 5 minutes here
        }

        // Set the interval for 5 minutes (5 minutes * 60 seconds/minute * 1000 milliseconds/second)
        const fiveMinutes = 1 * 60 * 1000;

        // Execute yourFunction every 5 minutes
        const intervalId = setInterval(yourFunction, fiveMinutes);
        updateRainData();
        updateWLevelData();
        console.log(`Interval started. Function will run every 5 minutes.`);

      });
    </script>
  </body>
</html>