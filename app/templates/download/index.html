{% extends 'base.html' %}
{% block title %}Download: BBWS Citanduy{% endblock %}
{% block page_desc %}Download Data BBWS Citanduy{% endblock %}
{% block content %}
<h2 class="border-start border-5 border-primary ps-2 fw-lighter mb-3">Download</h1>
    <div class="row mb-5">
        <div class="col-md-4">
            <div class="">
            <h4><i class="bi bi-cloud-download me-2"></i> Data Telemetri Sehari</h4>
            <form action="/download" method="POST" class="mt-3">
                <input type="hidden" name="sumber" value="telemetri">
                <input type="hidden" value={{ csrf_token() }} name="csrf_token">
                <p class="fs-6">Output Comma Separated Value (CSV) data per jam. 
                    <a href="#group1" data-bs-toggle="collapse" aria-expanded="true" aria-controls="group1" role="button">Contoh output</a></p>
                <div id="group1" class="collapse">
                <p>TMA<br>
                <code>Nama Pos | Kabupaten | jam 0, 1, 2..23</code><br/>
                Curah Hujan<br>
                <code>Nama Pos | Kabupaten | jam 7, 8, 9..6 (hari berikutnya)</code></p>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="tipe" value="1" id="pch">
                    <label class="form-check-label" for="pch">
                      Curah Hujan <strong>{{ ctx.pchs|length }}</strong> pos
                    </label>
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="radio" name="tipe" value="2" id="pda" checked>
                    <label class="form-check-label" for="flexRadioDefault2">
                      TMA <strong>{{ ctx.pdas|length }}</strong> pos
                    </label>
                  </div>
                <div class="mb-3">
                    <label for="sampling" class="form-label">Tanggal</label>
                    <input type="date" style="width: 160px !important" name="sampling" value="{{ ctx.today }}" class="form-control" id="sampling">
                </div>
                <div>
                    <input type="submit" name="submit" class="btn btn-outline-primary" id="submit" value="Download">
                </div>
            </form>
            </div>
        </div>
        <div class="col-md-4">
            <h4><i class="bi bi-cloud-download me-2"></i> Data Tele-Man Sebulan</h4>
            <form action="/download" method="POST" class="mt-3">
                <input type="hidden" name="periode" value="sebulan">
                <input type="hidden" value={{ csrf_token() }} name="csrf_token">
                    <a href="#group-telman" data-bs-toggle="collapse" aria-expanded="true" aria-controls="group1" role="button">Contoh output</a></p>
                <div id="group-telman" class="collapse">
                    <img src="/static/img/cth_download_rekap_hujan.png" class="img-fluid" alt="Contoh Output Download Rekap Hujan">
                </div>
                <div class="mb-3">
                    <label for="regionSelect" class="form-label">Pilih PCH / PDA Semua</label>
                    <select class="form-select" id="regionSelect" name="pos_id">
                    <optgroup label="A. Hujan">
                        <option value="pch_all">Semua PCH</option>
                    </optgroup>
                    <optgroup label="B. Tinggi Muka Air">
                        <option value="pda_all">Semua PDA</option>
                    </optgroup>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="sampling" class="form-label">Bulan</label>
                    <input type="month" style="width: 160px !important" name="sampling" value="{{ ctx.today.strftime('%Y-%m') }}" class="form-control" id="sampling">
                </div>
                <div>
                    <input type="submit" name="submit" class="btn btn-outline-primary" id="submit" value="Download">
                </div>
            </form>
        </div>
        <div class="col-md-4">
            <h4><i class="bi bi-cloud-download me-2"></i> Data Telemetri Sebulan /jam</h4>
            <form action="/download" method="POST" class="mt-3">
                <input type="hidden" name="periode" value="sebulan">
                <input type="hidden" value={{ csrf_token() }} name="csrf_token">
                    <a href="#group-tel-per-pos" data-bs-toggle="collapse" aria-expanded="true" aria-controls="group1" role="button">Contoh output</a></p>
                <div id="group-tel-per-pos" class="collapse">
                    <img src="/static/img/cth_download_rekap_hujan.png" class="img-fluid" alt="Contoh Output Download Rekap Hujan">
                </div>
                <div class="mb-3">
                    <label for="regionSelect" class="form-label">Pilih Pos</label>
                    <select class="form-select" id="regionSelect" name="pos_id">
                    <optgroup label="A. Hujan">
                        {%- for p in ctx.pchs %}
                        <option value="pch_{{ p.id }}">{{ p.nama }} - {{ p.kabupaten }}</option>
                        {%- endfor %}
                    </optgroup>
                    <optgroup label="B. Tinggi Muka Air">
                        {%- for p in ctx.pdas %}
                        <option value="pda_{{ p.id }}">{{ p.nama }} - {{ p.kabupaten }}</option>
                        {%- endfor %}
                    </optgroup>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="sampling" class="form-label">Bulan</label>
                    <input type="month" style="width: 160px !important" name="sampling" value="{{ ctx.today.strftime('%Y-%m') }}" class="form-control" id="sampling">
                </div>
                <div>
                    <input type="submit" name="submit" class="btn btn-outline-primary" id="submit" value="Download">
                </div>
            </form>
        </div>
    </div>
    <div class="row">
        <div class="col-sm-6 mt-2">
            <h4><i class="bi bi-water me-2"></i> Data Manual TMA</h4>
            <p><small><a href="#group3" data-bs-toggle="collapse" role="button" aria-controls="group3" aria-expanded="false">Contoh Output <i class="bi bi-arrow-right"></i></a></small></p>
                <div id="group3" class="collapse">
            <code>PDA Bandaruka<br/>
                Tanggal Download: 25-07-2025<br/>
                Tanggal, TMA7, TMA12, TMA17, TMARata-rata</code></div>
            <ol class="list-group list-group-numbered">
                {% for p in ctx.pdas %}
                <li class="list-group-item">
                    {{ p.nama }} <a href="#" onClick="dl({{ p.id }}, '{{ p.nama }}')" class="float-end link-underline-light"><i class="bi bi-download"></i> {{ p.count }} data</a>
                </li>
                {% endfor %}
            </ol>
        </div>
        <div class="col-sm-6 mt-2">
            <h4><i class="bi bi-cloud-rain me-2"></i> Data Manual Curah Hujan</h4>
            <small><p><a href="#group2">Contoh Output <i class="bi bi-arrow-right"></i></a></p>
                <div id="group2" class="collapse">
                <code>PCH Bulupayung<br/>
Tanggal Download: 25-07-2025<br/>
Tanggal, Curah hujan
            </code></small></div>
            <ol class="list-group list-group-numbered">
            {% for p in ctx.pchs %}
                <li class="list-group-item">{{ p.nama }}  <a href="#" onClick="dl({{ p.id }}, '{{ p.nama }}')" class="float-end link-underline-light"><i class="bi bi-download"></i> {{ p.count }} data</a>
                </li>
            {% endfor %}
            </ol>
        </div>
    </div>    
{% endblock %}
{% block js_foot %}
<script>
    const dl = async (pos_id, nama) => {
        let form = new FormData();
        form.append('pos_id', pos_id);
        const resp = await fetch('/download', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token() }}',
            },
            body: form
        });
        if (!resp.ok) {
            console.log('error response');
        }
        let data = await resp.text();
        const file = new Blob([data], {type: 'text/csv'});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(file);
        link.download = nama.replaceAll(' ', '_');
        link.click();
        URL.revokeObjectURL(link.href);
    }
</script>
{% endblock %}